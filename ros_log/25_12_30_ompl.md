# 配置自定义的ompl库

## 先重新配置moveit

ROS Noetic (Ubuntu 20.04) 版本的 MoveIt 源码安装与配置教程。

### 1. 准备工作：清理旧环境

如果你之前通过 apt 安装过二进制版本的 MoveIt，建议先卸载，以避免源码版本与系统版本冲突。

```bash
sudo apt-get remove ros-noetic-moveit-*
sudo apt-get autoremove
```

### 2. 更新软件包列表

配置一下软件源

```bash
rosdep update
sudo apt-get update
sudo apt-get dist-upgrade
```

### 3. 安装构建工具和依赖

在 Noetic (Ubuntu 20.04) 中，必须安装 python3 版本的工具 wstool, catkin-tools, clang-format

```bash
sudo apt-get install python3-wstool python3-catkin-tools clang-format
```

### 4. 创建工作空间

创建一个用于存放 MoveIt 源码的工作空间, 这里工作空间命名为moveit_ws。

```bash
mkdir -p ~/moveit_ws/src
cd ~/moveit_ws
```

### 5. 加载环境变量

```bash
source /opt/ros/noetic/setup.bash
```

### 6. 下载Moveit源码

```bash
# 初始化 wstool
wstool init src

# 合并 MoveIt 的 rosinstall 文件 (Noetic 使用 master 分支)
wstool merge -t src https://raw.githubusercontent.com/ros-planning/moveit/master/moveit.rosinstall

# 更新并下载源码
wstool update -t src
```

可能出现以下问题：

执行`wstool merge -t src https://raw.githubusercontent.com/ros-planning/moveit/master/moveit.rosinstall`指令终端停住了，一直卡在那。这是因为这通常是因为国内网络无法直接访问 raw.githubusercontent.com，导致终端请求一直处于等待（挂起）状态。
解决方法：

1. 使用代理地址，使用如下指令: `wstool merge -t src https://ghp.ci/https://raw.githubusercontent.com/ros-planning/moveit/master/moveit.rosinstall`(使用 ghp.ci 代理加速)、`wstool merge -t src https://mirror.ghproxy.com/https://raw.githubusercontent.com/ros-planning/moveit/master/moveit.rosinstall`。 但是我这里用代理都失败了，使用的是第二种方法
2. 手动创建文件。在工作空间(~/moveit_ws)下创建一个名为 moveit.rosinstall 的文件。
终端在~/moveit_ws位置，输入`gedit ~/moveit_ws/moveit.rosinstall`,将以下内容复制粘贴到打开的文件中，并保存。

```yaml
- git:
    local-name: moveit
    uri: https://github.com/ros-planning/moveit
    version: master
- git:
    local-name: moveit_msgs
    uri: https://github.com/ros-planning/moveit_msgs
    version: master
- git:
    local-name: moveit_resources
    uri: https://github.com/ros-planning/moveit_resources
    version: master
- git:
    local-name: geometric_shapes
    uri: https://github.com/ros-planning/geometric_shapes
    version: noetic-devel
- git:
    local-name: srdfdom
    uri: https://github.com/ros-planning/srdfdom
    version: noetic-devel
```

执行本地 Merge： 运行以下命令加载你刚才创建的本地文件：

```bash
wstool merge -t src ./moveit.rosinstall
```

完成后，执行更新命令，来下载源码

```bash
wstool update -t src
```

### 7. 安装项目依赖

```bash
rosdep install -y --from-paths src --ignore-src --rosdistro noetic
```

可能出现的问题：

```bash
ERROR: the following packages/stacks could not have their rosdep keys resolved

to system dependencies:

moveit_core: Cannot locate rosdep definition for [pybind11_catkin]
```

因为国内网络连接 GitHub 经常超时，导致数据库只下载了一部分，找不到这些常见的 key。

#### 1. 手动安装缺失的包

```bash
sudo apt-get install ros-noetic-pybind11-catkin ros-noetic-octomap-msgs ros-noetic-spacenav-node
```

#### 2. 重新运行依赖安装（跳过已安装的包）

```bash
# 如果有anaconda环境 要先退出
conda deactivate

# 尝试安装依赖 (添加了 skip-keys)
rosdep install -y --from-paths src --ignore-src --rosdistro noetic --skip-keys "pybind11_catkin octomap_msgs spacenav_node"
```

### 8. 编译工作空间

```bash
# 配置 catkin 工作空间
catkin config --extend /opt/ros/noetic --cmake-args -DCMAKE_BUILD_TYPE=Release

# 开始编译 (这一步可能需要较长时间，视电脑性能而定)
catkin build # catkin build -j2
```

### 9. 设置环境变量

编译完成后，需要 source 新工作空间的环境变量，以便系统能找到你编译的 MoveIt。

```bash
source ~/moveit_ws/devel/setup.bash
```

建议将此命令添加到你的 ~/.bashrc 文件中，方便以后自动加载：

```bash
echo "source ~/moveit_ws/devel/setup.bash" >> ~/.bashrc
source ~/.bashrc
```

### 10. 检测

检验源码安装是否成功，最核心的标准是：系统调用的 MoveIt 功能包是否真的来自你的 /home/你的计算机名称/moveit_ws 目录，而不是系统自带的目录。

#### 1. 检查环境变量

打开一个新的终端，先加载你的环境，然后查询 moveit_core 包的路径。

```bash
# 1. 加载环境
source ~/moveit_ws/devel/setup.bash

# 2. 询问系统：moveit_core 在哪里？
rospack find moveit_core
```

✅ ：输出路径类似 /home/你的计算机名称/moveit_ws/src/moveit/moveit_core。

❌ ：输出路径是 /opt/ros/noetic/share/moveit_core（说明系统还在用默认安装的版本，未加载你的源码）。

#### 2. 运行官方演示（视觉验证）

```bash
roslaunch moveit_resources_panda_moveit_config demo.launch
```

若成功则会打开RViz窗口，你会看到一个三维界面。界面中央有一个白色的 Franka Emika Panda 机械臂。

#### 3. 启动配置助手（工具验证）

```bash
roslaunch moveit_setup_assistant setup_assistant.launch
```

弹出一个标题为 "MoveIt Setup Assistant" 的图形化界面，且左侧有两个大按钮（Create New... / Edit Existing...），说明安装完全成功。

## 配置自定义的OMPL库

首先是要先获取OMPL的核心库，将系统自带的 OMPL 替换为源码编译版。

### 1. 移动到存放OMPL文件

建议单独建一个文件夹，来存放他。他只是一个C++的库，并不是ROS中的功能包。和前面创建的moveit_ws区分开，作为一个公共的C++库。

```bash
mkdir -p ~/ws_ompl
cd ~/ws_ompl
```

### 2. 下载 OMPL 源码

MoveIt Noetic 兼容 OMPL 1.5.x 版本。我们克隆 GitHub 仓库：

```bash
git clone https://github.com/ompl/ompl.git
cd ompl
# 切换到一个稳定的 tag 版本，避免 master 分支的不稳定
git checkout 1.5.2
```

### 3. 对源码进行修改

例如修改OMPL中的RRT-Connect的源文件。可以再solve()函数中添加一行打印输出，例如`OMPL_INFORM("========== hello world! first test ==========");`

### 4. 编译并安装

```bash
mkdir -p build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j4
sudo make install  # 这会将库安装到 /usr/local/lib
sudo ldconfig      # 刷新系统库缓存
```

## 修改OMPL库

直接去OMPL库进行修改
修改后进行编译

```bash
# 进入 OMPL 的构建目录
cd ~/ws_ompl/ompl/build

# 编译 (只编译修改的部分)
make -j4

# 安装到系统 (覆盖旧库)
sudo make install

# 刷新缓存 (这一步是个好习惯，防止系统找不到)
sudo ldconfig
```
